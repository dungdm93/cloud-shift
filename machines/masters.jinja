resources:
- name: {{ env['deployment'] }}-master-template
  type: compute.v1.instanceTemplate
  properties:
    description: 'OpenShift template for Master nodes'
    properties:
      tags:
        items:
        - openshift
        - openshift-master
      machineType: {{ properties['openshift_master_machine_type'] }}
      networkInterfaces:
      - network: $(ref.{{ env['deployment'] }}-network.selfLink)
        accessConfigs:
        - name: External NAT
          type: ONE_TO_ONE_NAT
      disks:
      - deviceName: boot
        type: PERSISTENT
        boot: true
        initializeParams:
          sourceImage:  projects/centos-cloud/global/images/family/centos-7
          diskSizeGb:   {{ properties['openshift_master_boot_disk_size'] }}
          diskType:     pd-standard
        autoDelete: true
      metadata:
        items:
        - key: user-data
          value: |
            {{ imports['masters.cloudinit'] | indent(12) }}
      serviceAccounts:
      - scopes:
        - https://www.googleapis.com/auth/cloud.useraccounts.readonly
        - https://www.googleapis.com/auth/compute
        - https://www.googleapis.com/auth/devstorage.read_only
        - https://www.googleapis.com/auth/logging.write
        - https://www.googleapis.com/auth/monitoring.write
        - https://www.googleapis.com/auth/service.management.readonly
        - https://www.googleapis.com/auth/servicecontrol
      scheduling:
        onHostMaintenance: MIGRATE
        automaticRestart: true
        preemptible: false
  metadata:
    dependsOn:
    - {{ env['deployment'] }}-network
- name: {{ env['deployment'] }}-master-group
  type: compute.v1.regionInstanceGroupManager
  properties:
    description: 'OpenShift instance group of Master nodes'
    region: {{ properties['region'] }}
    instanceTemplate: $(ref.{{ env['deployment'] }}-master-template.selfLink)
    targetPools:      {{ properties['openshift_master_target_pools'] }}
    baseInstanceName: {{ env['deployment'] }}-master
    targetSize: {{ properties['openshift_master_instance_group_size'] }}
    namedPorts:
    - name: openshift-web-console
      port: {{ properties['openshift_console_port'] }}
- name: {{ env['deployment'] }}-master-https-health-check
  type: compute.v1.healthCheck
  properties:
    description: 'HTTPS health check of OpenShift master instances'
    checkIntervalSec:   5
    timeoutSec:         5
    unhealthyThreshold: 2
    healthyThreshold:   2
    type: HTTPS
    httpsHealthCheck:
      port:        {{ properties['openshift_console_port'] }}
      portName:    openshift-web-console
      requestPath: /healthz
      proxyHeader: NONE
- name: {{ env['deployment'] }}-master-network-health-check
  type: compute.v1.httpHealthCheck
  properties:
    description: 'Internal health check of OpenShift master instances'
    host:        NONE
    requestPath: /healthz
    port:        8080
    checkIntervalSec:   5
    timeoutSec:         5
    unhealthyThreshold: 2
    healthyThreshold:   2
